import{h as Y,g as V,j as Z,k as ee,l as Q,m as ie,n as X,p as le,q as ue,s as I,t as de,u as se,r as b,v as ce,C as $,x as j,y as U,N as ge,a as l,d,e as D,f as r,z as s,A as me,B as C,D as pe,E as fe,F as _e,G as ve,H as K,I as E,J as P,K as p,L as F,M as W,O as te,P as x,R as q,S as ae,U as oe,V as he,W as ye,X as we,Y as M,Z as ne,_ as N,$ as ke,o as xe,a0 as De}from"./index.f797b370.js";import{Q as be,a as Le,b as qe,c as Se,d as $e,e as Ce}from"./QLayout.574b3e8f.js";import{Q as B,a as z,b as Qe}from"./QItem.5b3967a4.js";import{Q as Ae}from"./QList.0927c3c1.js";import{Q as re}from"./QScrollArea.bb7cb16a.js";import{w as H}from"./root_url.456ded4c.js";import{_ as Ie}from"./plugin-vue_export-helper.21dcd24c.js";import"./QResizeObserver.0a3cf539.js";import"./QScrollObserver.50454ab8.js";var Re=Y({name:"QToolbarTitle",props:{shrink:Boolean},setup(a,{slots:o}){const v=V(()=>"q-toolbar__title ellipsis"+(a.shrink===!0?" col-shrink":""));return()=>Z("div",{class:v.value},ee(o.default))}}),Ue=Y({name:"QPage",props:{padding:Boolean,styleFn:Function},setup(a,{slots:o}){const{proxy:{$q:v}}=ie(),t=X(le,Q);if(t===Q)return console.error("QPage needs to be a deep child of QLayout"),Q;if(X(ue,Q)===Q)return console.error("QPage needs to be child of QPageContainer"),Q;const i=V(()=>{const g=(t.header.space===!0?t.header.size:0)+(t.footer.space===!0?t.footer.size:0);if(typeof a.styleFn=="function"){const w=t.isContainer.value===!0?t.containerHeight.value:v.screen.height;return a.styleFn(g,w)}return{minHeight:t.isContainer.value===!0?t.containerHeight.value-g+"px":v.screen.height===0?g!==0?`calc(100vh - ${g}px)`:"100vh":v.screen.height-g+"px"}}),c=V(()=>`q-page${a.padding===!0?" q-layout-padding":""}`);return()=>Z("main",{class:c.value,style:i.value},ee(o.default))}});I("proyojonuserkey",{});const A=I("proyojonloginuser",{});ce.title="Requesting To Server...";const T=de("message store",()=>{se();const a=b(null),o=b(null),v=b(""),t=b(null),h=b(!1),i=b(!1),c=b(null),g=b(!1),w=async()=>{if(!o.value)return;i.value=!0;const m={method:"get",url:"api/message",headers:{"Content-Type":"application/json",Authorization:`Bearer ${A.value.token}`},params:{user1:A.value._id,user2:o.value.user._id}};$("get-message").showLoading();try{const e=await j.request(m);e.data.messages=e.data.messages.sort(function(n,f){return new Date(n.updatedAt)-new Date(f.updatedAt)}),c.value=e.data,t.value=e.data.page+1,i.value=!1,$("get-message").hideLoading()}catch(e){console.log(e),i.value=!1,$("get-message").hideLoading()}};return{selectedRoom:a,messageList:c,selectedRoomUser2:o,messageContent:v,messageSending:h,messageSent:g,getMessages:w,getPreviousMessages:async()=>{var e,n,f,_;if(!((e=o.value)!=null&&e.user)||((n=c.value)==null?void 0:n.pages)<t.value&&i.value==!1)return;console.log("getting previous messages"),i.value=!0;const m={method:"get",url:"api/message",headers:{"Content-Type":"application/json",Authorization:`Bearer ${A.value.token}`},params:{user1:A.value._id,user2:(_=(f=o.value)==null?void 0:f.user)==null?void 0:_._id,pageNumber:t.value}};$("get-message-s").showLoading();try{const u=await j.request(m);u.data.messages=u.data.messages.sort(function(k,S){return new Date(k.updatedAt)-new Date(S.updatedAt)}),c.value.messages.push(...u.data.messages),c.value.page=u.data.page,t.value=u.data.page+1,i.value=!1,$("get-message-s").hideLoading()}catch(u){console.log(u),i.value=!1,$("get-message-s").hideLoading()}},nextPageNumber:t,messageListLoading:i,createMessage:async()=>{const m={room:a.value,recipient:o.value.user._id,content:v.value,token:A.value.token};U.emit("creating_new_message",{...m});const e={method:"post",url:"api/message",headers:{"Content-Type":"application/json",Authorization:`Bearer ${A.value.token}`},data:m};h.value=!0,g.value=!1,$("post-message").showLoading();try{const n=await j.request(e);w(),h.value=!0,g.value=!1,v.value="",$("post-message").hideLoading()}catch(n){console.log(n),$("post-message").hideLoading(),ge.create({position:"center",type:"negative",message:n.response.data.message})}}}});const Me=["onKeypress"],Pe={style:{position:"absolute",left:"50%",top:"50%",transform:"translate(-50%, -50%)"}},Te={__name:"typeWriter",setup(a){const o=T(),{height:v,width:t}=_e,h=b(!1),i=b(null),c=()=>{t(i.value)/o.messageContent.length<=6.6?h.value=!0:h.value=!1},g=()=>{o.messageContent.length!=0&&(o.createMessage(),h.value=!1)};return(w,L)=>(l(),d("div",{class:"relative-position q-pa-sm text-black",onKeypress:fe(g,["enter"])},[D("div",{ref_key:"inputTextEl",ref:i,style:{width:"calc(100% - 50px)"}},[r(me,{modelValue:s(o).messageContent,"onUpdate:modelValue":[L[0]||(L[0]=y=>s(o).messageContent=y),c],type:h.value?"textarea":"text",outlined:"",dense:"",rounded:"",counter:"",maxlength:"1000"},null,8,["modelValue","type"])],512),D("div",{class:"absolute-top-right",style:{width:"50px",height:"100%"},onClick:g},[D("div",Pe,[r(pe,{class:C(["fs-25 text-white sendbutton",[w.$q.screen.gt.sm?"bg-primary":"bg-green"]]),name:"send",style:{"margin-top":"-19px","border-radius":"50%"}},null,8,["class"])])])],40,Me))}},je={key:0,class:"flex justify-center q-mt-sm"},Be={key:1,class:"text-center text-grey-6 q-mt-sm"},Ve=["src"],Fe={class:""},Ne={key:0},ze={key:0},He={key:1},Ke={key:1},Ee={__name:"messageArea",setup(a){const o=T(),{messageList:v}=ve(o),t=K(),h=E(),i=b(null),c=()=>{o.getPreviousMessages()},g=()=>{i.value.setScrollPercentage("vertical",1,100)};return U.on("new_message",w=>{setTimeout(()=>{g()},50)}),(w,L)=>(l(),P(re,{ref_key:"scrollAreaRef",ref:i,class:"full-width q-px-sm",style:{height:"calc(100vh - 130px)"}},{default:p(()=>{var y,m;return[((y=s(v))==null?void 0:y.pages)>=s(o).nextPageNumber?(l(),d("div",je,[r(F,{rounded:"",outline:"",label:"load more",size:"sm",loading:s(o).messageListLoading,onClick:c},null,8,["loading"])])):(l(),d("div",Be,"no more content to load")),(l(!0),d(W,null,te((m=s(o).messageList)==null?void 0:m.messages,(e,n)=>{var f,_;return l(),d("div",{key:n},[D("div",{class:C(["q-message q-mx-sm",[s(t).loginUserInfo._id!==e.sender._id?"q-message-sent":"q-message-received "]])},[D("div",{class:C(["q-message-container row items-end no-wrap",[s(t).loginUserInfo._id!==e.sender._id?"":"reverse"]])},[D("img",{class:"q-message-avatar q-message-avatar--received",src:s(H)+((f=e.sender)!=null&&f.profileImage?(_=e.sender)==null?void 0:_.profileImage:"/images/user-placeholder.jpg"),"aria-hidden":"true"},null,8,Ve),D("div",Fe,[D("div",{class:C(["q-message-name",[s(t).loginUserInfo._id!==e.sender._id?"q-message-name--received":"q-message-name--sent"]])},x(s(t).loginUserInfo._id!==e.sender._id?e.sender.name[s(h).language]:"me"),3),D("div",{class:C(["q-message-text",[s(t).loginUserInfo._id!==e.sender._id?"q-message-text--received bg-primary text-primary":"q-message-text--sent"]])},[D("div",{class:C(["q-message-text-content",[s(t).loginUserInfo._id!==e.sender._id?"q-message-text-content--received":"q-message-text-content--sent"]])},[D("div",{class:C([s(t).loginUserInfo._id!==e.sender._id?"text-white":"text-black"])},x(e.content),3),D("div",{class:C(["q-message-stamp",[s(t).loginUserInfo._id!==e.sender._id?"text-white":"text-black"]])},[s(q).isSameDate(new Date,e.updatedAt,"days")?(l(),d("span",Ne,[s(q).getDateDiff(new Date,e.updatedAt,"hour")==0?(l(),d("span",ze,x(s(q).getDateDiff(new Date,e.updatedAt,"minute"))+" minute ago ",1)):(l(),d("span",He,x(s(q).getDateDiff(new Date,e.updatedAt,"hour"))+" hour ago ",1))])):(l(),d("span",Ke,x(s(q).getDateDiff(new Date,e.updatedAt,"days"))+" days ago",1))],2)],2)],2)])],2)],2)])}),128))]}),_:1},512))}},We=["src"],Oe=["src"],Ge={key:0},Je={key:1},Xe={key:0},Ye={key:0},Ze={key:1},es={key:1},ss={__name:"roomsView",props:{room:Object},setup(a){const o=new Date(2017,3,8),v="days";q.getDateDiff(new Date,o,"days");const t=I("myrooms",{}),h=I("proyojonloginuser",{}),i=ae(),c=T(),g=oe(),w=se(),L=K(),y=E(),m=n=>{var f;w.push("/direct_message/"+n),c.selectedRoom=n;for(let _ of(f=t.value)==null?void 0:f.rooms)_._id==n&&(c.selectedRoomUser2=_.participants.filter(u=>u.user._id!==h.value._id)[0]);c.getMessages()};var e=new Audio("/sounds/new_messenge_ton.mp3");return U.on("new_message",n=>{var f;i.getMyRooms(),n._doc.sender._id!==L.loginUserInfo._id&&(((f=i.myRoomList)==null?void 0:f.rooms[0]._id)===g.params.id&&c.messageList.messages[c.messageList.messages.length-1]._id!==n._doc._id&&c.messageList.messages.push(n._doc),e.play())}),U.on("receiving_new_message",n=>{console.log("receiving new message",n)}),(n,f)=>(l(),d(W,null,[he((l(),P(Qe,{clickable:"",onClick:f[0]||(f[0]=_=>m(a.room._id))},{default:p(()=>[r(B,{avatar:""},{default:p(()=>[r(we,null,{default:p(()=>{var _,u,k,S,R,O,G,J;return[a.room.participants[0].user._id!==s(L).loginUserInfo._id?(l(),d("img",{key:0,src:s(H)+((u=(_=a.room.participants[0])==null?void 0:_.user)!=null&&u.profileImage?(S=(k=a.room.participants[0])==null?void 0:k.user)==null?void 0:S.profileImage:"/images/user-placeholder.jpg")},null,8,We)):(l(),d("img",{key:1,src:s(H)+((O=(R=a.room.participants[1])==null?void 0:R.user)!=null&&O.profileImage?(J=(G=a.room.participants[1])==null?void 0:G.user)==null?void 0:J.profileImage:"/images/user-placeholder.jpg")},null,8,Oe))]}),_:1})]),_:1}),r(B,null,{default:p(()=>{var _;return[r(z,{lines:"1"},{default:p(()=>{var u,k,S;return[((u=a.room.participants[0].user)==null?void 0:u._id)!==s(L).loginUserInfo._id?(l(),d("span",Ge,x((k=a.room.participants[0].user)==null?void 0:k.name[s(y).language]),1)):(l(),d("span",Je,x((S=a.room.participants[1].user)==null?void 0:S.name[s(y).language]),1))]}),_:1}),(_=a.room)!=null&&_.messages?(l(),P(z,{key:0,caption:"",lines:"2"},{default:p(()=>{var u,k;return[M(x((k=(u=a.room)==null?void 0:u.messages)==null?void 0:k.content),1)]}),_:1})):ne("",!0)]}),_:1}),r(B,{side:"",top:"",class:"fs-10"},{default:p(()=>{var _,u,k,S,R;return[s(q).isSameDate(new Date,(_=a.room)==null?void 0:_.updatedAt,v)?(l(),d("span",Xe,[s(q).getDateDiff(new Date,(u=a.room)==null?void 0:u.updatedAt,"hour")==0?(l(),d("span",Ye,x(s(q).getDateDiff(new Date,(k=a.room)==null?void 0:k.updatedAt,"minute"))+" minute ago ",1)):(l(),d("span",Ze,x(s(q).getDateDiff(new Date,(S=a.room)==null?void 0:S.updatedAt,"hour"))+" hour ago ",1))])):(l(),d("span",es,x(s(q).getDateDiff(new Date,(R=a.room)==null?void 0:R.updatedAt,v))+" days ago",1))]}),_:1})]),_:1})),[[ye]]),r(N)],64))}};const ts={key:0},as={__name:"messengerPage",setup(a){var L;const o=I("myrooms",{}),v=I("proyojonloginuser",{}),t=E(),h=ae(),i=T(),c=K(),g=oe(),w=b(!1);if(!ke(g.params)){i.selectedRoom=g.params.id;for(let y of(L=o.value)==null?void 0:L.rooms)y._id==g.params.id&&(i.selectedRoomUser2=y.participants.filter(m=>m.user._id!==v.value._id)[0]);i.getMessages()}return xe(()=>{h.getMyRooms()}),De(()=>{c.checkLogin()}),U.on("new_message",y=>{}),(y,m)=>(l(),P(Ce,{view:"lHh Lpr lFf",container:"",style:{height:"100vh"},class:"shadow-2"},{default:p(()=>[r(Le,{elevated:"",class:C([y.$q.screen.gt.sm?"bg-accent-public":"bg-red-8"])},{default:p(()=>[r(be,null,{default:p(()=>[r(F,{flat:"",onClick:m[0]||(m[0]=e=>w.value=!w.value),round:"",dense:"",icon:"menu"}),r(Re,null,{default:p(()=>{var e,n;return[M(x(s(i).selectedRoomUser2?(n=(e=s(i).selectedRoomUser2)==null?void 0:e.user)==null?void 0:n.name[s(t).language]:"Select user."),1)]}),_:1}),r(F,{flat:"",dense:"",onClick:m[1]||(m[1]=e=>y.$router.push("/users"))},{default:p(()=>[M(x(y.$t("headermenus.users")),1)]),_:1})]),_:1})]),_:1},8,["class"]),r(qe,{modelValue:w.value,"onUpdate:modelValue":m[2]||(m[2]=e=>w.value=e),"show-if-above":"",width:300,breakpoint:500},{default:p(()=>[r(re,{class:"fit"},{default:p(()=>[r(N,{vertical:""}),r(Ae,{bordered:"",class:"rounded-borders",style:{"max-width":"350px"}},{default:p(()=>{var e;return[r(z,{header:""},{default:p(()=>[M("Messages List")]),_:1}),r(N),s(h).myRoomList?(l(),d("div",ts,[(l(!0),d(W,null,te((e=s(h).myRoomList)==null?void 0:e.rooms,(n,f)=>(l(),d("div",{key:f},[r(ss,{room:n},null,8,["room"])]))),128))])):ne("",!0)]}),_:1})]),_:1})]),_:1},8,["modelValue"]),r(Se,null,{default:p(()=>[r(Ue,null,{default:p(()=>[r(Ee)]),_:1})]),_:1}),r($e,{elevated:"",class:"bg-white"},{default:p(()=>[r(Te)]),_:1})]),_:1}))}};var ms=Ie(as,[["__scopeId","data-v-d36956c0"]]);export{ms as default};
