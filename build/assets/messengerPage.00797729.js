import{h as O,g as B,j as G,k as J,l as $,m as ae,n as W,p as oe,q as ne,s as C,t as re,u as X,r as k,v as ie,C as q,x as P,y as R,N as le,a as i,d,e as w,f as l,z as s,A as ue,B as S,D as de,E as ce,F as ge,G as me,H as N,I as z,J as U,K as p,L as j,M as H,O as Y,P as y,R as L,S as Z,U as ee,V as pe,W as fe,X as _e,Y as I,Z as se,_ as ve,$ as he,o as ye,a0 as we}from"./index.ac7231d3.js";import{Q as ke,a as xe,b as De,c as Le,d as be,e as qe}from"./QLayout.2772db89.js";import{Q as V}from"./QItemLabel.b1a21688.js";import{Q as Se}from"./QList.19b31c2c.js";import{Q as te}from"./QScrollArea.8fedfe15.js";import{w as F}from"./root_url.5e50e74c.js";import{Q as T,a as $e}from"./QItem.1e2bb0ee.js";import{_ as Qe}from"./plugin-vue_export-helper.21dcd24c.js";import"./QResizeObserver.e4863725.js";import"./QScrollObserver.97fa3460.js";var Ce=O({name:"QToolbarTitle",props:{shrink:Boolean},setup(a,{slots:o}){const f=B(()=>"q-toolbar__title ellipsis"+(a.shrink===!0?" col-shrink":""));return()=>G("div",{class:f.value},J(o.default))}}),Ae=O({name:"QPage",props:{padding:Boolean,styleFn:Function},setup(a,{slots:o}){const{proxy:{$q:f}}=ae(),t=W(oe,$);if(t===$)return console.error("QPage needs to be a deep child of QLayout"),$;if(W(ne,$)===$)return console.error("QPage needs to be child of QPageContainer"),$;const r=B(()=>{const g=(t.header.space===!0?t.header.size:0)+(t.footer.space===!0?t.footer.size:0);if(typeof a.styleFn=="function"){const h=t.isContainer.value===!0?t.containerHeight.value:f.screen.height;return a.styleFn(g,h)}return{minHeight:t.isContainer.value===!0?t.containerHeight.value-g+"px":f.screen.height===0?g!==0?`calc(100vh - ${g}px)`:"100vh":f.screen.height-g+"px"}}),c=B(()=>`q-page${a.padding===!0?" q-layout-padding":""}`);return()=>G("main",{class:c.value,style:r.value},J(o.default))}});C("proyojonuserkey",{});const Q=C("proyojonloginuser",{});ie.title="Requesting To Server...";const M=re("message store",()=>{X();const a=k(null),o=k(null),f=k(""),t=k(null),_=k(!1),r=k(!1),c=k(null),g=k(!1),h=async()=>{if(!o.value)return;r.value=!0;const m={method:"get",url:"api/message",headers:{"Content-Type":"application/json",Authorization:`Bearer ${Q.value.token}`},params:{user1:Q.value._id,user2:o.value.user._id}};q("get-message").showLoading();try{const e=await P.request(m);e.data.messages=e.data.messages.sort(function(n,u){return new Date(n.updatedAt)-new Date(u.updatedAt)}),c.value=e.data,t.value=e.data.page+1,r.value=!1,q("get-message").hideLoading()}catch(e){console.log(e),r.value=!1,q("get-message").hideLoading()}};return{selectedRoom:a,messageList:c,selectedRoomUser2:o,messageContent:f,messageSending:_,messageSent:g,getMessages:h,getPreviousMessages:async()=>{var e,n;if(!((e=o.value)!=null&&e.user)||((n=c.value)==null?void 0:n.pages)<t.value&&r.value==!1)return;console.log("getting previous messages"),r.value=!0;const m={method:"get",url:"api/message",headers:{"Content-Type":"application/json",Authorization:`Bearer ${Q.value.token}`},params:{user1:Q.value._id,user2:o.value.user._id,pageNumber:t.value}};q("get-message-s").showLoading();try{const u=await P.request(m);u.data.messages=u.data.messages.sort(function(D,b){return new Date(D.updatedAt)-new Date(b.updatedAt)}),c.value.messages.push(...u.data.messages),c.value.page=u.data.page,t.value=u.data.page+1,r.value=!1,q("get-message-s").hideLoading()}catch(u){console.log(u),r.value=!1,q("get-message-s").hideLoading()}},nextPageNumber:t,messageListLoading:r,createMessage:async()=>{const m={room:a.value,recipient:o.value.user._id,content:f.value,token:Q.value.token};R.emit("creating_new_message",{...m});const e={method:"post",url:"api/message",headers:{"Content-Type":"application/json",Authorization:`Bearer ${Q.value.token}`},data:m};_.value=!0,g.value=!1,q("post-message").showLoading();try{const n=await P.request(e);h(),_.value=!0,g.value=!1,f.value="",q("post-message").hideLoading()}catch(n){console.log(n),q("post-message").hideLoading(),le.create({position:"center",type:"negative",message:n.response.data.message})}}}});const Re=["onKeypress"],Ie={style:{position:"absolute",left:"50%",top:"50%",transform:"translate(-50%, -50%)"}},Ue={__name:"typeWriter",setup(a){const o=M(),{height:f,width:t}=ge,_=k(!1),r=k(null),c=()=>{t(r.value)/o.messageContent.length<=6.6?_.value=!0:_.value=!1},g=()=>{o.messageContent.length!=0&&(o.createMessage(),_.value=!1)};return(h,x)=>(i(),d("div",{class:"relative-position q-pa-sm text-black",onKeypress:ce(g,["enter"])},[w("div",{ref_key:"inputTextEl",ref:r,style:{width:"calc(100% - 50px)"}},[l(ue,{modelValue:s(o).messageContent,"onUpdate:modelValue":[x[0]||(x[0]=v=>s(o).messageContent=v),c],type:_.value?"textarea":"text",outlined:"",dense:"",rounded:"",counter:"",maxlength:"1000"},null,8,["modelValue","type"])],512),w("div",{class:"absolute-top-right",style:{width:"50px",height:"100%"},onClick:g},[w("div",Ie,[l(de,{class:S(["fs-25 text-white sendbutton",[h.$q.screen.gt.sm?"bg-primary":"bg-green"]]),name:"send",style:{"margin-top":"-19px","border-radius":"50%"}},null,8,["class"])])])],40,Re))}},Me={key:0,class:"flex justify-center q-mt-sm"},Pe={key:1,class:"text-center text-grey-6 q-mt-sm"},Te=["src"],Be={class:""},je={key:0},Ve={key:0},Fe={key:1},Ne={key:1},ze={__name:"messageArea",setup(a){const o=M(),{messageList:f}=me(o),t=N(),_=z(),r=k(null),c=()=>{o.getPreviousMessages()},g=()=>{r.value.setScrollPercentage("vertical",1,100)};return R.on("new_message",h=>{setTimeout(()=>{g()},50)}),(h,x)=>(i(),U(te,{ref_key:"scrollAreaRef",ref:r,class:"full-width q-px-sm",style:{height:"calc(100vh - 130px)"}},{default:p(()=>{var v,m;return[((v=s(f))==null?void 0:v.pages)>=s(o).nextPageNumber?(i(),d("div",Me,[l(j,{rounded:"",outline:"",label:"load more",size:"sm",loading:s(o).messageListLoading,onClick:c},null,8,["loading"])])):(i(),d("div",Pe,"no more content to load")),(i(!0),d(H,null,Y((m=s(o).messageList)==null?void 0:m.messages,(e,n)=>{var u;return i(),d("div",{key:n},[w("div",{class:S(["q-message q-mx-sm",[s(t).loginUserInfo._id!==e.sender._id?"q-message-sent":"q-message-received "]])},[w("div",{class:S(["q-message-container row items-end no-wrap",[s(t).loginUserInfo._id!==e.sender._id?"":"reverse"]])},[w("img",{class:"q-message-avatar q-message-avatar--received",src:s(F)+((u=e.sender)==null?void 0:u.profileImage),"aria-hidden":"true"},null,8,Te),w("div",Be,[w("div",{class:S(["q-message-name",[s(t).loginUserInfo._id!==e.sender._id?"q-message-name--received":"q-message-name--sent"]])},y(s(t).loginUserInfo._id!==e.sender._id?e.sender.name[s(_).language]:"me"),3),w("div",{class:S(["q-message-text",[s(t).loginUserInfo._id!==e.sender._id?"q-message-text--received bg-primary text-primary":"q-message-text--sent"]])},[w("div",{class:S(["q-message-text-content",[s(t).loginUserInfo._id!==e.sender._id?"q-message-text-content--received":"q-message-text-content--sent"]])},[w("div",{class:S([s(t).loginUserInfo._id!==e.sender._id?"text-white":"text-black"])},y(e.content),3),w("div",{class:S(["q-message-stamp",[s(t).loginUserInfo._id!==e.sender._id?"text-white":"text-black"]])},[s(L).isSameDate(new Date,e.updatedAt,"days")?(i(),d("span",je,[s(L).getDateDiff(new Date,e.updatedAt,"hour")==0?(i(),d("span",Ve,y(s(L).getDateDiff(new Date,e.updatedAt,"minute"))+" minute ago ",1)):(i(),d("span",Fe,y(s(L).getDateDiff(new Date,e.updatedAt,"hour"))+" hour ago ",1))])):(i(),d("span",Ne,y(s(L).getDateDiff(new Date,e.updatedAt,"days"))+" days ago",1))],2)],2)],2)])],2)],2)])}),128))]}),_:1},512))}},He=["src"],Ke=["src"],Ee={key:0},We={key:1},Oe={key:0},Ge={key:0},Je={key:1},Xe={key:1},Ye={__name:"roomsView",props:{room:Object},setup(a){const o=new Date(2017,3,8),f="days";L.getDateDiff(new Date,o,"days");const t=C("myrooms",{}),_=C("proyojonloginuser",{}),r=Z(),c=M(),g=ee(),h=X(),x=N(),v=z(),m=n=>{var u;h.push("/direct_message/"+n),c.selectedRoom=n;for(let D of(u=t.value)==null?void 0:u.rooms)D._id==n&&(c.selectedRoomUser2=D.participants.filter(b=>b.user._id!==_.value._id)[0]);c.getMessages()};var e=new Audio("/sounds/new_messenge_ton.mp3");return R.on("new_message",n=>{var u;r.getMyRooms(),n._doc.sender._id!==x.loginUserInfo._id&&(((u=r.myRoomList)==null?void 0:u.rooms[0]._id)===g.params.id&&c.messageList.messages[c.messageList.messages.length-1]._id!==n._doc._id&&c.messageList.messages.push(n._doc),e.play())}),R.on("receiving_new_message",n=>{console.log("receiving new message",n)}),(n,u)=>(i(),d(H,null,[pe((i(),U($e,{clickable:"",onClick:u[0]||(u[0]=D=>m(a.room._id))},{default:p(()=>[l(T,{avatar:""},{default:p(()=>[l(_e,null,{default:p(()=>[a.room.participants[0].user._id!==s(x).loginUserInfo._id?(i(),d("img",{key:0,src:s(F)+a.room.participants[0].user.profileImage},null,8,He)):(i(),d("img",{key:1,src:s(F)+a.room.participants[1].user.profileImage},null,8,Ke))]),_:1})]),_:1}),l(T,null,{default:p(()=>{var D;return[l(V,{lines:"1"},{default:p(()=>[a.room.participants[0].user._id!==s(x).loginUserInfo._id?(i(),d("span",Ee,y(a.room.participants[0].user.name[s(v).language]),1)):(i(),d("span",We,y(a.room.participants[1].user.name[s(v).language]),1))]),_:1}),(D=a.room)!=null&&D.messages?(i(),U(V,{key:0,caption:"",lines:"2"},{default:p(()=>{var b,A;return[I(y((A=(b=a.room)==null?void 0:b.messages)==null?void 0:A.content),1)]}),_:1})):se("",!0)]}),_:1}),l(T,{side:"",top:"",class:"fs-10"},{default:p(()=>{var D,b,A,K,E;return[s(L).isSameDate(new Date,(D=a.room)==null?void 0:D.updatedAt,f)?(i(),d("span",Oe,[s(L).getDateDiff(new Date,(b=a.room)==null?void 0:b.updatedAt,"hour")==0?(i(),d("span",Ge,y(s(L).getDateDiff(new Date,(A=a.room)==null?void 0:A.updatedAt,"minute"))+" minute ago ",1)):(i(),d("span",Je,y(s(L).getDateDiff(new Date,(K=a.room)==null?void 0:K.updatedAt,"hour"))+" hour ago ",1))])):(i(),d("span",Xe,y(s(L).getDateDiff(new Date,(E=a.room)==null?void 0:E.updatedAt,f))+" days ago",1))]}),_:1})]),_:1})),[[fe]]),l(ve)],64))}};const Ze={key:0},es={__name:"messengerPage",setup(a){var x;const o=C("myrooms",{}),f=C("proyojonloginuser",{}),t=z(),_=Z(),r=M(),c=N(),g=ee(),h=k(!1);if(!he(g.params)){r.selectedRoom=g.params.id;for(let v of(x=o.value)==null?void 0:x.rooms)v._id==g.params.id&&(r.selectedRoomUser2=v.participants.filter(m=>m.user._id!==f.value._id)[0]);r.getMessages()}return ye(()=>{_.getMyRooms()}),we(()=>{c.checkLogin()}),R.on("new_message",v=>{}),(v,m)=>(i(),U(qe,{view:"lHh Lpr lFf",container:"",style:{height:"100vh"},class:"shadow-2"},{default:p(()=>[l(xe,{elevated:"",class:S([v.$q.screen.gt.sm?"bg-accent-public":"bg-red-8"])},{default:p(()=>[l(ke,null,{default:p(()=>[l(j,{flat:"",onClick:m[0]||(m[0]=e=>h.value=!h.value),round:"",dense:"",icon:"menu"}),l(Ce,null,{default:p(()=>{var e,n;return[I(y(s(r).selectedRoomUser2?(n=(e=s(r).selectedRoomUser2)==null?void 0:e.user)==null?void 0:n.name[s(t).language]:"Select user."),1)]}),_:1}),l(j,{flat:"",dense:"",onClick:m[1]||(m[1]=e=>v.$router.push("/users"))},{default:p(()=>[I(y(v.$t("headermenus.users")),1)]),_:1})]),_:1})]),_:1},8,["class"]),l(De,{modelValue:h.value,"onUpdate:modelValue":m[2]||(m[2]=e=>h.value=e),"show-if-above":"",width:300,breakpoint:500},{default:p(()=>[l(te,{class:"fit"},{default:p(()=>[l(Se,{bordered:"",class:"rounded-borders",style:{"max-width":"350px"}},{default:p(()=>{var e;return[l(V,{header:""},{default:p(()=>[I("Messages List")]),_:1}),s(_).myRoomList?(i(),d("div",Ze,[(i(!0),d(H,null,Y((e=s(_).myRoomList)==null?void 0:e.rooms,(n,u)=>(i(),d("div",{key:u},[l(Ye,{room:n},null,8,["room"])]))),128))])):se("",!0)]}),_:1})]),_:1})]),_:1},8,["modelValue"]),l(Le,null,{default:p(()=>[l(Ae,null,{default:p(()=>[l(ze)]),_:1})]),_:1}),l(be,{elevated:"",class:"bg-white"},{default:p(()=>[l(Ue)]),_:1})]),_:1}))}};var cs=Qe(es,[["__scopeId","data-v-49214a96"]]);export{cs as default};
