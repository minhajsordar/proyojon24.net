import{h as W,g as T,j as O,k as G,l as $,m as te,n as E,p as ae,q as oe,s as C,t as ne,u as J,r as k,v as re,x as M,y as L,N as ie,a as i,d,e as w,f as l,z as s,A as le,B as S,C as ue,D as de,E as ce,F as me,G as F,H as N,I,J as p,K as B,L as z,M as X,O as y,P as b,R as Y,S as Z,U as ge,V as pe,W as fe,X as R,Y as ee,Z as _e,_ as ve,o as he,$ as ye}from"./index.98f545c8.js";import{Q as we,a as ke,b as xe,c as De,d as be,e as qe}from"./QLayout.f153a4bc.js";import{Q as j}from"./QItemLabel.c62d8aea.js";import{Q as Se}from"./QList.8d37962b.js";import{Q as se}from"./QScrollArea.bddbe02c.js";import{w as V}from"./root_url.5e50e74c.js";import{Q as P,a as $e}from"./QItem.e51bf348.js";import{_ as Qe}from"./plugin-vue_export-helper.21dcd24c.js";import"./QResizeObserver.4c0b85a0.js";import"./QScrollObserver.1254b7a6.js";var Ce=W({name:"QToolbarTitle",props:{shrink:Boolean},setup(a,{slots:o}){const f=T(()=>"q-toolbar__title ellipsis"+(a.shrink===!0?" col-shrink":""));return()=>O("div",{class:f.value},G(o.default))}}),Ae=W({name:"QPage",props:{padding:Boolean,styleFn:Function},setup(a,{slots:o}){const{proxy:{$q:f}}=te(),t=E(ae,$);if(t===$)return console.error("QPage needs to be a deep child of QLayout"),$;if(E(oe,$)===$)return console.error("QPage needs to be child of QPageContainer"),$;const r=T(()=>{const m=(t.header.space===!0?t.header.size:0)+(t.footer.space===!0?t.footer.size:0);if(typeof a.styleFn=="function"){const h=t.isContainer.value===!0?t.containerHeight.value:f.screen.height;return a.styleFn(m,h)}return{minHeight:t.isContainer.value===!0?t.containerHeight.value-m+"px":f.screen.height===0?m!==0?`calc(100vh - ${m}px)`:"100vh":f.screen.height-m+"px"}}),c=T(()=>`q-page${a.padding===!0?" q-layout-padding":""}`);return()=>O("main",{class:c.value,style:r.value},G(o.default))}});C("proyojonuserkey",{});const Q=C("proyojonloginuser",{});re.title="Requesting To Server...";const U=ne("message store",()=>{J();const a=k(null),o=k(null),f=k(""),t=k(null),_=k(!1),r=k(!1),c=k(null),m=k(!1),h=async()=>{if(!o.value)return;r.value=!0;const g={method:"get",url:"api/message",headers:{"Content-Type":"application/json",Authorization:`Bearer ${Q.value.token}`},params:{user1:Q.value._id,user2:o.value.user._id}};try{const e=await M.request(g);e.data.messages=e.data.messages.sort(function(n,u){return new Date(n.updatedAt)-new Date(u.updatedAt)}),c.value=e.data,t.value=e.data.page+1,r.value=!1}catch(e){console.log(e),r.value=!1}};return{selectedRoom:a,messageList:c,selectedRoomUser2:o,messageContent:f,messageSending:_,messageSent:m,getMessages:h,getPreviousMessages:async()=>{var e,n;if(!((e=o.value)!=null&&e.user)||((n=c.value)==null?void 0:n.pages)<t.value&&r.value==!1)return;console.log("getting previous messages"),r.value=!0;const g={method:"get",url:"api/message",headers:{"Content-Type":"application/json",Authorization:`Bearer ${Q.value.token}`},params:{user1:Q.value._id,user2:o.value.user._id,pageNumber:t.value}};try{const u=await M.request(g);u.data.messages=u.data.messages.sort(function(D,q){return new Date(D.updatedAt)-new Date(q.updatedAt)}),c.value.messages.push(...u.data.messages),c.value.page=u.data.page,t.value=u.data.page+1,r.value=!1}catch(u){console.log(u),r.value=!1}},nextPageNumber:t,messageListLoading:r,createMessage:async()=>{const g={room:a.value,recipient:o.value.user._id,content:f.value,token:Q.value.token};L.emit("creating_new_message",{...g});const e={method:"post",url:"api/message",headers:{"Content-Type":"application/json",Authorization:`Bearer ${Q.value.token}`},data:g};_.value=!0,m.value=!1;try{const n=await M.request(e);h(),_.value=!0,m.value=!1,f.value=""}catch(n){console.log(n),ie.create({position:"center",type:"negative",message:n.response.data.message})}}}});const Le=["onKeypress"],Re={style:{position:"absolute",left:"50%",top:"50%",transform:"translate(-50%, -50%)"}},Ie={__name:"typeWriter",setup(a){const o=U(),{height:f,width:t}=ce,_=k(!1),r=k(null),c=()=>{t(r.value)/o.messageContent.length<=6.6?_.value=!0:_.value=!1},m=()=>{o.messageContent.length!=0&&(o.createMessage(),_.value=!1)};return(h,x)=>(i(),d("div",{class:"relative-position q-pa-sm text-black",onKeypress:de(m,["enter"])},[w("div",{ref_key:"inputTextEl",ref:r,style:{width:"calc(100% - 50px)"}},[l(le,{modelValue:s(o).messageContent,"onUpdate:modelValue":[x[0]||(x[0]=v=>s(o).messageContent=v),c],type:_.value?"textarea":"text",outlined:"",dense:"",rounded:"",counter:"",maxlength:"1000"},null,8,["modelValue","type"])],512),w("div",{class:"absolute-top-right",style:{width:"50px",height:"100%"},onClick:m},[w("div",Re,[l(ue,{class:S(["fs-25 text-white sendbutton",[h.$q.screen.gt.sm?"bg-primary":"bg-green"]]),name:"send",style:{"margin-top":"-19px","border-radius":"50%"}},null,8,["class"])])])],40,Le))}},Ue={key:0,class:"flex justify-center q-mt-sm"},Me={key:1,class:"text-center text-grey-6 q-mt-sm"},Pe=["src"],Te={class:""},Be={key:0},je={key:0},Ve={key:1},Fe={key:1},Ne={__name:"messageArea",setup(a){const o=U(),{messageList:f}=me(o),t=F(),_=N(),r=k(null),c=()=>{o.getPreviousMessages()},m=()=>{r.value.setScrollPercentage("vertical",1,100)};return L.on("new_message",h=>{setTimeout(()=>{m()},50)}),(h,x)=>(i(),I(se,{ref_key:"scrollAreaRef",ref:r,class:"full-width q-px-sm",style:{height:"calc(100vh - 130px)"}},{default:p(()=>{var v,g;return[((v=s(f))==null?void 0:v.pages)>=s(o).nextPageNumber?(i(),d("div",Ue,[l(B,{rounded:"",outline:"",label:"load more",size:"sm",loading:s(o).messageListLoading,onClick:c},null,8,["loading"])])):(i(),d("div",Me,"no more content to load")),(i(!0),d(z,null,X((g=s(o).messageList)==null?void 0:g.messages,(e,n)=>{var u;return i(),d("div",{key:n},[w("div",{class:S(["q-message q-mx-sm",[s(t).loginUserInfo._id!==e.sender._id?"q-message-sent":"q-message-received "]])},[w("div",{class:S(["q-message-container row items-end no-wrap",[s(t).loginUserInfo._id!==e.sender._id?"":"reverse"]])},[w("img",{class:"q-message-avatar q-message-avatar--received",src:s(V)+((u=e.sender)==null?void 0:u.profileImage),"aria-hidden":"true"},null,8,Pe),w("div",Te,[w("div",{class:S(["q-message-name",[s(t).loginUserInfo._id!==e.sender._id?"q-message-name--received":"q-message-name--sent"]])},y(s(t).loginUserInfo._id!==e.sender._id?e.sender.name[s(_).language]:"me"),3),w("div",{class:S(["q-message-text",[s(t).loginUserInfo._id!==e.sender._id?"q-message-text--received bg-primary text-primary":"q-message-text--sent"]])},[w("div",{class:S(["q-message-text-content",[s(t).loginUserInfo._id!==e.sender._id?"q-message-text-content--received":"q-message-text-content--sent"]])},[w("div",{class:S([s(t).loginUserInfo._id!==e.sender._id?"text-white":"text-black"])},y(e.content),3),w("div",{class:S(["q-message-stamp",[s(t).loginUserInfo._id!==e.sender._id?"text-white":"text-black"]])},[s(b).isSameDate(new Date,e.updatedAt,"days")?(i(),d("span",Be,[s(b).getDateDiff(new Date,e.updatedAt,"hour")==0?(i(),d("span",je,y(s(b).getDateDiff(new Date,e.updatedAt,"minute"))+" minute ago ",1)):(i(),d("span",Ve,y(s(b).getDateDiff(new Date,e.updatedAt,"hour"))+" hour ago ",1))])):(i(),d("span",Fe,y(s(b).getDateDiff(new Date,e.updatedAt,"days"))+" days ago",1))],2)],2)],2)])],2)],2)])}),128))]}),_:1},512))}},ze=["src"],He=["src"],Ke={key:0},Ee={key:1},We={key:0},Oe={key:0},Ge={key:1},Je={key:1},Xe={__name:"roomsView",props:{room:Object},setup(a){const o=new Date(2017,3,8),f="days";b.getDateDiff(new Date,o,"days");const t=C("myrooms",{}),_=C("proyojonloginuser",{}),r=Y(),c=U(),m=Z(),h=J(),x=F(),v=N(),g=n=>{var u;h.push("/direct_message/"+n),c.selectedRoom=n;for(let D of(u=t.value)==null?void 0:u.rooms)D._id==n&&(c.selectedRoomUser2=D.participants.filter(q=>q.user._id!==_.value._id)[0]);c.getMessages()};var e=new Audio("/sounds/new_messenge_ton.mp3");return L.on("new_message",n=>{var u;r.getMyRooms(),n._doc.sender._id!==x.loginUserInfo._id&&(((u=r.myRoomList)==null?void 0:u.rooms[0]._id)===m.params.id&&c.messageList.messages[c.messageList.messages.length-1]._id!==n._doc._id&&c.messageList.messages.push(n._doc),e.play())}),L.on("receiving_new_message",n=>{console.log("receiving new message",n)}),(n,u)=>(i(),d(z,null,[ge((i(),I($e,{clickable:"",onClick:u[0]||(u[0]=D=>g(a.room._id))},{default:p(()=>[l(P,{avatar:""},{default:p(()=>[l(fe,null,{default:p(()=>[a.room.participants[0].user._id!==s(x).loginUserInfo._id?(i(),d("img",{key:0,src:s(V)+a.room.participants[0].user.profileImage},null,8,ze)):(i(),d("img",{key:1,src:s(V)+a.room.participants[1].user.profileImage},null,8,He))]),_:1})]),_:1}),l(P,null,{default:p(()=>{var D;return[l(j,{lines:"1"},{default:p(()=>[a.room.participants[0].user._id!==s(x).loginUserInfo._id?(i(),d("span",Ke,y(a.room.participants[0].user.name[s(v).language]),1)):(i(),d("span",Ee,y(a.room.participants[1].user.name[s(v).language]),1))]),_:1}),(D=a.room)!=null&&D.messages?(i(),I(j,{key:0,caption:"",lines:"2"},{default:p(()=>{var q,A;return[R(y((A=(q=a.room)==null?void 0:q.messages)==null?void 0:A.content),1)]}),_:1})):ee("",!0)]}),_:1}),l(P,{side:"",top:"",class:"fs-10"},{default:p(()=>{var D,q,A,H,K;return[s(b).isSameDate(new Date,(D=a.room)==null?void 0:D.updatedAt,f)?(i(),d("span",We,[s(b).getDateDiff(new Date,(q=a.room)==null?void 0:q.updatedAt,"hour")==0?(i(),d("span",Oe,y(s(b).getDateDiff(new Date,(A=a.room)==null?void 0:A.updatedAt,"minute"))+" minute ago ",1)):(i(),d("span",Ge,y(s(b).getDateDiff(new Date,(H=a.room)==null?void 0:H.updatedAt,"hour"))+" hour ago ",1))])):(i(),d("span",Je,y(s(b).getDateDiff(new Date,(K=a.room)==null?void 0:K.updatedAt,f))+" days ago",1))]}),_:1})]),_:1})),[[pe]]),l(_e)],64))}};const Ye={key:0},Ze={__name:"messengerPage",setup(a){var x;const o=C("myrooms",{}),f=C("proyojonloginuser",{}),t=N(),_=Y(),r=U(),c=F(),m=Z(),h=k(!1);if(!ve(m.params)){r.selectedRoom=m.params.id;for(let v of(x=o.value)==null?void 0:x.rooms)v._id==m.params.id&&(r.selectedRoomUser2=v.participants.filter(g=>g.user._id!==f.value._id)[0]);r.getMessages()}return he(()=>{_.getMyRooms()}),ye(()=>{c.checkLogin()}),L.on("new_message",v=>{}),(v,g)=>(i(),I(qe,{view:"lHh Lpr lFf",container:"",style:{height:"100vh"},class:"shadow-2"},{default:p(()=>[l(ke,{elevated:"",class:S([v.$q.screen.gt.sm?"bg-accent-public":"bg-red-8"])},{default:p(()=>[l(we,null,{default:p(()=>[l(B,{flat:"",onClick:g[0]||(g[0]=e=>h.value=!h.value),round:"",dense:"",icon:"menu"}),l(Ce,null,{default:p(()=>{var e,n;return[R(y(s(r).selectedRoomUser2?(n=(e=s(r).selectedRoomUser2)==null?void 0:e.user)==null?void 0:n.name[s(t).language]:"Select user."),1)]}),_:1}),l(B,{flat:"",dense:"",onClick:g[1]||(g[1]=e=>v.$router.push("/users"))},{default:p(()=>[R(y(v.$t("headermenus.users")),1)]),_:1})]),_:1})]),_:1},8,["class"]),l(xe,{modelValue:h.value,"onUpdate:modelValue":g[2]||(g[2]=e=>h.value=e),"show-if-above":"",width:300,breakpoint:500},{default:p(()=>[l(se,{class:"fit"},{default:p(()=>[l(Se,{bordered:"",class:"rounded-borders",style:{"max-width":"350px"}},{default:p(()=>{var e;return[l(j,{header:""},{default:p(()=>[R("Messages List")]),_:1}),s(_).myRoomList?(i(),d("div",Ye,[(i(!0),d(z,null,X((e=s(_).myRoomList)==null?void 0:e.rooms,(n,u)=>(i(),d("div",{key:u},[l(Xe,{room:n},null,8,["room"])]))),128))])):ee("",!0)]}),_:1})]),_:1})]),_:1},8,["modelValue"]),l(De,null,{default:p(()=>[l(Ae,null,{default:p(()=>[l(Ne)]),_:1})]),_:1}),l(be,{elevated:"",class:"bg-white"},{default:p(()=>[l(Ie)]),_:1})]),_:1}))}};var ds=Qe(Ze,[["__scopeId","data-v-49214a96"]]);export{ds as default};
